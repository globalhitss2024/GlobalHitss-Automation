# ====================================================================
# Pipeline para validaci√≥n de scripts ETL
# Autor: Jefferson Rozo
# Fecha: Marzo 2024
# ====================================================================

name: ETL Validation Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de validaci√≥n' 
        required: true
        default: 'test'
        type: choice
        options:
        - test  # Para pruebas locales
        - staging  # Para pruebas pre-producci√≥n

env:
  PYTHON_VERSION: '3.10'  # Versi√≥n estable que usamos en producci√≥n

jobs:
  validate-scripts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint pytest

      - name: Validate ETL Scripts
        run: |
          # Lista de scripts core que deben existir siempre
          CORE_SCRIPTS=(
            # Scripts de cancelaciones
            "cargue_datos_crudos_base_canceladas/cargue_datos_crudos_canceladas.py"
            "cargue_datos_crudos_base_canceladas_999/cargue_datos_crudos_canceladas_999.py"
            
            # Scripts de digitaciones
            "cargue_datos_crudos_base_digitadas/cargue_datos_crudos_digitadas.py" 
            "cargue_datos_crudos_base_digitadas_up/cargue_datos_crudos_digitadas_up.py"
            
            # Scripts de instalaciones
            "cargue_datos_crudos_base_instaladas/cargue_datos_crudos_instaladas.py"
            "cargue_datos_crudos_base_instaladas_999/cargue_datos_crudos_instaladas_999.py"
            
            # Scripts principales
            "cargue_datos_crudos_conciliaciones/conciliaciones.py"
            "cargue_datos_crudos_legalizadas/cargue_datos_crudos_legalizadas.py"
            "cargue_datos_crudos_metas/cargue_datos_crudos_metas.py"
            "cargue_datos_crudos_transfers/transfers_crudos.py"
          )

          # Scripts opcionales que pueden no existir
          OPTIONAL_SCRIPTS=(
            "cargue_datos_crudos_base_digitadas_comercial/fuentes_crudas_digitadas_comercial.py"
            "cargue_datos_crudos_base_liquidacion_fija/cargue_datos_crudos_liquidacion_fija.py" 
            "cargue_datos_crudos_reports_comercial/reports_comercial.py"
            "cargue_datos_crudos_otros_movimientos/otros_movimientos.py"
          )

          # Variable para controlar si hay errores
          VALIDATION_FAILED=0

          # Funci√≥n para validar un script
          validate_script() {
            local script=$1
            local is_core=$2

            echo "üîç Validando: $script"

            # Buscar el script en el directorio
            if [ ! -f "$script" ]; then
              if [ "$is_core" = true ]; then
                echo "‚ùå ERROR: Script core no encontrado: $script"
                return 1
              else
                echo "‚ö†Ô∏è Advertencia: Script opcional no encontrado: $script"
                return 0
              fi
            fi

            # Validar sintaxis Python
            if ! python -m py_compile "$script"; then
              echo "‚ùå Error de sintaxis en: $script"
              return 1
            fi

            echo "‚úÖ Script validado correctamente: $script"
            return 0
          }

          # Validar scripts core
          echo "=== Validando scripts core ==="
          for script in "${CORE_SCRIPTS[@]}"; do
            if ! validate_script "$script" true; then
              VALIDATION_FAILED=1
            fi
          done

          # Validar scripts opcionales
          echo -e "\n=== Validando scripts opcionales ==="
          for script in "${OPTIONAL_SCRIPTS[@]}"; do
            validate_script "$script" false
          done

          exit $VALIDATION_FAILED